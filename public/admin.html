<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MotoGP - Admin Dashboard</title>
    <link href="bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
    <style>
        .sidebar {
            min-height: 100vh;
            background: #f8f9fa;
            padding: 20px;
        }
        .content {
            padding: 20px;
        }
        .nav-pills .nav-link {
            color: #333;
        }
        .nav-pills .nav-link.active {
            background-color: #0d6efd;
            color: white;
        }

        /* Results table styles */
        .position-badge {
            display: inline-block;
            min-width: 30px;
            padding: 2px 8px;
            border-radius: 12px;
            text-align: center;
            font-weight: bold;
            background-color: #f8f9fa;
        }

        .points-badge {
            display: inline-block;
            min-width: 30px;
            padding: 2px 8px;
            border-radius: 12px;
            text-align: center;
            font-weight: bold;
            background-color: #e9ecef;
        }

        .rider-info {
            display: flex;
            flex-direction: column;
        }

        .rider-info small {
            font-size: 0.85em;
        }

        .podium-position-1 {
            background-color: rgba(255, 215, 0, 0.1) !important;
        }

        .podium-position-2 {
            background-color: rgba(192, 192, 192, 0.1) !important;
        }

        .podium-position-3 {
            background-color: rgba(205, 127, 50, 0.1) !important;
        }

        .table-light td {
            height: 10px;
            padding: 0 !important;
            background-color: #f8f9fa;
        }

        /* Results Section Styles */
        .table > :not(caption) > * > * {
            padding: 1rem;
            vertical-align: middle;
        }

        .table-secondary {
            background-color: #f8f9fa !important;
        }

        .table-secondary td {
            font-size: 1.1em;
            padding: 0.75rem 1rem !important;
        }

        .points-badge {
            display: inline-block;
            padding: 0.4rem 0.8rem;
            background-color: var(--motogp-red);
            color: white;
            border-radius: 20px;
            font-weight: bold;
            min-width: 45px;
            text-align: center;
        }

        .position-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            background-color: #f8f9fa;
            font-weight: bold;
            margin: 0 auto;
        }

        tr.podium-position-1 .position-badge {
            background-color: #ffd700;
            color: black;
        }

        tr.podium-position-2 .position-badge {
            background-color: #c0c0c0;
            color: black;
        }

        tr.podium-position-3 .position-badge {
            background-color: #cd7f32;
            color: white;
        }

        .btn-group-action {
            display: flex;
            gap: 0.5rem;
            justify-content: flex-end;
        }

        .btn-group-action .btn {
            padding: 0.375rem 0.75rem;
        }

        .race-header {
            background-color: #f8f9fa;
            font-weight: bold;
            font-size: 1.1em;
        }

        .race-header td {
            padding: 1rem !important;
            border-top: 2px solid #dee2e6;
        }

        /* Add some spacing between race groups */
        .race-group:not(:last-child) {
            margin-bottom: 1rem;
        }

        /* Improve form select appearance */
        .form-select {
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            border: 1px solid #dee2e6;
            background-color: #fff;
            font-size: 1rem;
            line-height: 1.5;
            transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
        }

        .form-select:focus {
            border-color: var(--motogp-red);
            box-shadow: 0 0 0 0.25rem rgba(220, 53, 69, 0.25);
        }

        /* Style for the action buttons */
        .btn-action {
            padding: 0.375rem 0.75rem;
            font-size: 0.875rem;
            border-radius: 0.25rem;
            transition: all 0.2s;
        }

        .btn-action:hover {
            transform: translateY(-1px);
        }

        /* Add hover effect to table rows */
        .table tbody tr:hover {
            background-color: rgba(0, 0, 0, 0.02);
        }

        /* Add some spacing in the card */
        .card-body {
            padding: 1.5rem;
        }

        /* Make the table header sticky */
        .table thead {
            position: sticky;
            top: 0;
            z-index: 1;
        }

        /* Basic styling */
        .table > :not(caption) > * > * {
            padding: 0.75rem;
        }

        .table-striped tbody tr:nth-of-type(odd) {
            background-color: rgba(0, 0, 0, 0.05);
        }

        .btn-action {
            padding: 0.25rem 0.5rem;
            font-size: 0.875rem;
        }

        .race-header {
            background-color: #f8f9fa;
            font-weight: bold;
        }

        .race-header td {
            padding: 0.75rem !important;
        }

        /* Form styling */
        .form-select {
            padding: 0.375rem 0.75rem;
            border: 1px solid #ced4da;
        }

        /* Teams table specific styles */
        #teamsTable tbody tr:nth-child(odd) {
            background-color: rgba(0, 0, 0, 0.05);
        }

        #teamsTable td {
            vertical-align: middle;
            padding: 1rem;
        }

        #teamsTable .btn {
            padding: 0.375rem 0.75rem;
            font-size: 0.875rem;
        }

        #teamsTable .btn-warning {
            background-color: #ffc107;
            border-color: #ffc107;
            margin-right: 0.5rem;
        }

        #teamsTable .btn-danger {
            background-color: #dc3545;
            border-color: #dc3545;
        }

        #teamsTable img {
            height: 40px;
            width: auto;
            object-fit: contain;
        }

        /* Results table specific styles */
        #resultsTable tbody tr:nth-child(even) {
            background-color: rgba(0, 0, 0, 0.05);
        }

        #resultsTable td {
            vertical-align: middle;
            padding: 1rem;
        }

        #resultsTable .race-header {
            background-color: #e9ecef;
            font-weight: bold;
        }

        #resultsTable .btn {
            padding: 0.375rem 0.75rem;
            font-size: 0.875rem;
        }

        #resultsTable .btn-warning {
            background-color: #ffc107;
            border-color: #ffc107;
            margin-right: 0.5rem;
        }

        #resultsTable .btn-danger {
            background-color: #dc3545;
            border-color: #dc3545;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <div class="col-md-2 sidebar">
                <div class="text-center mb-4">
                    <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/f/f9/MotoGP_logo_%282024%29.svg/1200px-MotoGP_logo_%282024%29.svg.png" alt="MotoGP Logo" style="height: 40px;">
                </div>
                <div class="nav flex-column nav-pills">
                    <button class="nav-link active" data-bs-toggle="pill" data-bs-target="#riders">Riders</button>
                    <button class="nav-link" data-bs-toggle="pill" data-bs-target="#teams">Teams</button>
                    <button class="nav-link" data-bs-toggle="pill" data-bs-target="#results">Results</button>
                    <button class="nav-link" data-bs-toggle="pill" data-bs-target="#calendar">Calendar</button>
                    <button class="nav-link" id="logoutBtn">Logout</button>
                </div>
            </div>

            <!-- Main Content -->
            <div class="col-md-10 content">
                <div class="tab-content">
                    <!-- Riders Section -->
                    <div class="tab-pane fade show active" id="riders">
                        <h2>Manage Riders</h2>
                        <button class="btn btn-primary mb-3" data-bs-toggle="modal" data-bs-target="#addRiderModal">Add New Rider</button>
                        <div class="table-responsive">
                            <table class="table table-striped" id="ridersTable">
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                        <th>Team</th>
                                        <th>Nationality</th>
                                        <th>Photo</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Teams Section -->
                    <div class="tab-pane fade" id="teams">
                        <h2>Manage Teams</h2>
                        <button class="btn btn-danger mb-4" data-bs-toggle="modal" data-bs-target="#addTeamModal">Add New Team</button>
                        <div class="table-responsive">
                            <table class="table" id="teamsTable">
                                <thead>
                                    <tr>
                                        <th style="width: 30%">Team Name</th>
                                        <th style="width: 20%">Rider 1</th>
                                        <th style="width: 20%">Rider 2</th>
                                        <th style="width: 15%">Team Picture</th>
                                        <th style="width: 15%">Actions</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Results Section -->
                    <div class="tab-pane fade" id="results">
                        <h2>Manage Results</h2>
                        <button class="btn btn-danger mb-4" onclick="showAddResultModal()">Add New Result</button>
                        
                        <div class="mb-3">
                            <label for="raceSelect" class="form-label">Filter by Race:</label>
                            <select class="form-select" id="raceSelect">
                                <option value="">All Races</option>
                            </select>
                        </div>

                        <div class="table-responsive">
                            <table class="table" id="resultsTable">
                                <thead>
                                    <tr>
                                        <th>Position</th>
                                        <th>Rider</th>
                                        <th>Team</th>
                                        <th>Time</th>
                                        <th>Points</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Calendar Section -->
                    <div class="tab-pane fade" id="calendar">
                        <h2>Manage Calendar</h2>
                        <button class="btn btn-primary mb-3" data-bs-toggle="modal" data-bs-target="#addCalendarModal">Add New Race</button>
                        <div class="table-responsive">
                            <table class="table table-striped" id="calendarTable">
                                <thead>
                                    <tr>
                                        <th>Race Name</th>
                                        <th>Country</th>
                                        <th>Start Date</th>
                                        <th>End Date</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Rider Modal -->
    <div class="modal fade" id="addRiderModal">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add New Rider</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="addRiderForm">
                        <div class="mb-3">
                            <label class="form-label">Name</label>
                            <input type="text" class="form-control" name="name" required placeholder="e.g., Marc MÃ¡rquez">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Team (Optional)</label>
                            <select class="form-control" name="team_id">
                                <option value="">No Team</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Nationality</label>
                            <input type="text" class="form-control" name="country" required placeholder="e.g., Spain">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Photo</label>
                            <input type="file" class="form-control" name="photo" accept=".webp" required>
                            <small class="form-text text-muted">Upload a .webp image file</small>
                        </div>
                        <button type="submit" class="btn btn-primary">Add Rider</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Team Modal -->
    <div class="modal fade" id="addTeamModal">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add New Team</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="addTeamForm">
                        <!-- Team Information -->
                        <div class="mb-3">
                            <label class="form-label">Team Name</label>
                            <input type="text" class="form-control" name="team_name" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Team Picture</label>
                            <input type="file" class="form-control" name="team_photo" accept=".webp" required>
                        </div>

                        <!-- Rider 1 Section -->
                        <div class="border p-3 mb-3">
                            <h6>Rider 1</h6>
                            <div class="mb-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="rider1_type" value="existing" checked>
                                    <label class="form-check-label">Select Existing Rider</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="rider1_type" value="new">
                                    <label class="form-check-label">Add New Rider</label>
                                </div>
                            </div>

                            <!-- Existing Rider 1 Selection -->
                            <div class="rider1-existing">
                                <div class="mb-3">
                                    <label class="form-label">Select Rider</label>
                                    <select class="form-control" name="rider1_id"></select>
                                </div>
                            </div>

                            <!-- New Rider 1 Form -->
                            <div class="rider1-new" style="display: none;">
                                <div class="mb-3">
                                    <label class="form-label">Name</label>
                                    <input type="text" class="form-control" name="rider1_name">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Nationality</label>
                                    <input type="text" class="form-control" name="rider1_nationality">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Photo</label>
                                    <input type="file" class="form-control" name="rider1_photo" accept=".webp">
                                </div>
                            </div>
                        </div>

                        <!-- Rider 2 Section -->
                        <div class="border p-3 mb-3">
                            <h6>Rider 2</h6>
                            <div class="mb-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="rider2_type" value="existing" checked>
                                    <label class="form-check-label">Select Existing Rider</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="rider2_type" value="new">
                                    <label class="form-check-label">Add New Rider</label>
                                </div>
                            </div>

                            <!-- Existing Rider 2 Selection -->
                            <div class="rider2-existing">
                                <div class="mb-3">
                                    <label class="form-label">Select Rider</label>
                                    <select class="form-control" name="rider2_id"></select>
                                </div>
                            </div>

                            <!-- New Rider 2 Form -->
                            <div class="rider2-new" style="display: none;">
                                <div class="mb-3">
                                    <label class="form-label">Name</label>
                                    <input type="text" class="form-control" name="rider2_name">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Nationality</label>
                                    <input type="text" class="form-control" name="rider2_nationality">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Photo</label>
                                    <input type="file" class="form-control" name="rider2_photo" accept=".webp">
                                </div>
                            </div>
                        </div>

                        <button type="submit" class="btn btn-primary">Add Team</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Rider Modal -->
    <div class="modal fade" id="editRiderModal">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit Rider</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editRiderForm">
                        <input type="hidden" name="rider_id">
                        <input type="hidden" name="current_team_id">
                        
                        <div class="mb-3">
                            <label class="form-label">Name</label>
                            <input type="text" class="form-control" name="name" required>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Nationality</label>
                            <input type="text" class="form-control" name="country" required>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Team</label>
                            <select class="form-control" name="team_id">
                                <option value="">No Team</option>
                            </select>
                            <small class="form-text text-muted">Only teams with less than 2 riders are available</small>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Update Photo</label>
                            <input type="file" class="form-control" name="photo" accept=".webp">
                            <small class="form-text text-muted">Leave empty to keep current photo. Only .webp files allowed.</small>
                        </div>
                        
                        <button type="submit" class="btn btn-primary">Update Rider</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Team Modal -->
    <div class="modal fade" id="editTeamModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit Team</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editTeamForm">
                        <input type="hidden" name="team_id">
                        <input type="hidden" name="current_rider1_id">
                        <input type="hidden" name="current_rider2_id">
                        
                        <div class="mb-3">
                            <label class="form-label">Team Name</label>
                            <input type="text" class="form-control" name="team_name" required>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Team Photo</label>
                            <input type="file" class="form-control" name="team_photo" accept=".webp">
                            <small class="text-muted">Leave empty to keep current photo. Only .webp files allowed.</small>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Rider 1</label>
                            <select class="form-select" name="rider1_id">
                                <option value="">Select Rider 1</option>
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Rider 2</label>
                            <select class="form-select" name="rider2_id">
                                <option value="">Select Rider 2</option>
                            </select>
                        </div>
                        
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="submit" class="btn btn-primary">Save Changes</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Result Modal -->
    <div class="modal fade" id="addResultModal">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add New Result</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="addResultForm">
                        <div class="mb-3">
                            <label class="form-label">Race</label>
                            <select class="form-control" name="calendar_id" required>
                                <option value="">Select Race</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Rider</label>
                            <select class="form-control" name="rider_id" required>
                                <option value="">Select Rider</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Team</label>
                            <select class="form-control" name="team_id" required>
                                <option value="">Select Team</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Race Time</label>
                            <input type="text" class="form-control" name="race_time" required placeholder="e.g., 42:15.123">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Points</label>
                            <input type="number" class="form-control" name="points" required min="0" max="25">
                        </div>
                        <button type="submit" class="btn btn-primary">Add Result</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Result Modal -->
    <div class="modal fade" id="editResultModal">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit Result</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editResultForm">
                        <input type="hidden" name="result_id">
                        <div class="mb-3">
                            <label class="form-label">Race</label>
                            <select class="form-control" name="calendar_id" required></select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Rider</label>
                            <select class="form-control" name="rider_id" required></select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Team</label>
                            <select class="form-control" name="team_id" required></select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Time (format: HH:MM:SS)</label>
                            <input type="text" class="form-control" name="race_time" required pattern="^(?:(?:([01]?\d|2[0-3]):)?([0-5]?\d):)?([0-5]?\d)$" placeholder="00:40:55">
                        </div>
                        <button type="submit" class="btn btn-primary">Update Result</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Calendar Modal -->
    <div class="modal fade" id="addCalendarModal">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add New Race</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="addCalendarForm">
                        <div class="mb-3">
                            <label class="form-label">Race Name</label>
                            <input type="text" class="form-control" name="race_name" required placeholder="e.g., Qatar Airways Grand Prix of Qatar">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Country</label>
                            <input type="text" class="form-control" name="country" required placeholder="e.g., QATAR">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Start Date</label>
                            <input type="date" class="form-control" name="start_date" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">End Date</label>
                            <input type="date" class="form-control" name="end_date" required>
                        </div>
                        <button type="submit" class="btn btn-primary">Add Race</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Calendar Modal -->
    <div class="modal fade" id="editCalendarModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit Race</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editCalendarForm">
                        <input type="hidden" name="calendar_id">
                        
                        <div class="mb-3">
                            <label class="form-label">Race Name</label>
                            <input type="text" class="form-control" name="race_name" required>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Country</label>
                            <input type="text" class="form-control" name="country" required>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Start Date</label>
                            <input type="date" class="form-control" name="start_date" required>
                            <small class="text-muted">Race weekend start date</small>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">End Date</label>
                            <input type="date" class="form-control" name="end_date" required>
                            <small class="text-muted">Race weekend end date</small>
                        </div>
                        
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="submit" class="btn btn-primary">Save Changes</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script src="bootstrap.bundle.min.js"></script>
    <script>
        // Check authentication
        fetch('/check-auth')
            .then(response => {
                if (!response.ok) throw new Error('Network response was not ok');
                return response.json();
            })
            .then(data => {
                if (!data.authenticated) {
                    window.location.href = '/login.html';
                } else {
                    // Only load data if authenticated
                    loadRiders();
                    loadTeams();
                    loadResults();
                    loadCalendar();
                }
            })
            .catch(error => {
                console.error('Authentication error:', error);
                window.location.href = '/login.html';
            });

        // Logout handler
        document.getElementById('logoutBtn').addEventListener('click', () => {
            fetch('/logout', { method: 'POST' })
                .then(response => {
                    if (!response.ok) throw new Error('Network response was not ok');
                    return response.json();
                })
                .then(() => {
                    window.location.href = '/login.html';
                })
                .catch(error => {
                    console.error('Logout error:', error);
                    alert('Failed to logout. Please try again.');
                });
        });

        // Load data functions
        function loadRiders() {
            // First load teams to populate team dropdown
            fetch('/api/teams')
                .then(response => {
                    if (!response.ok) throw new Error('Network response was not ok');
                    return response.json();
                })
                .then(teams => {
                    // Update team select options
                    const teamSelects = document.querySelectorAll('select[name="team_id"]');
                    const teamOptions = teams.map(team => 
                        `<option value="${team.team_id}">${escapeHtml(team.team_name)}</option>`
                    ).join('');
                    teamSelects.forEach(select => {
                        select.innerHTML = '<option value="">No Team</option>' + teamOptions;
                    });
                })
                .catch(error => {
                    console.error('Error loading teams:', error);
                });

            // Then load riders with their team information
            fetch('/api/riders')
                .then(response => {
                    if (!response.ok) throw new Error('Network response was not ok');
                    return response.json();
                })
                .then(riders => {
                    const tbody = document.querySelector('#ridersTable tbody');
                    tbody.innerHTML = '';
                    riders.forEach(rider => {
                        tbody.innerHTML += `
                            <tr>
                                <td>${escapeHtml(rider.name || '')}</td>
                                <td>${escapeHtml(rider.team || 'Not assigned')}</td>
                                <td>${escapeHtml(rider.nationality || '')}</td>
                                <td>
                                    ${rider.image_url ? 
                                        `<img src="/images/rider/${escapeHtml(rider.image_url)}" alt="${escapeHtml(rider.name)}" height="50" class="rounded">` : 
                                        'No photo'
                                    }
                                </td>
                                <td>
                                    <button class="btn btn-sm btn-warning" onclick="editRider(${rider.rider_id})">Edit</button>
                                    <button class="btn btn-sm btn-danger" onclick="deleteRider(${rider.rider_id})">Delete</button>
                                </td>
                            </tr>
                        `;
                    });

                    // Filter unassigned riders for team forms
                    const unassignedRiders = riders.filter(rider => !rider.team_id);
                    const unassignedRiderOptions = unassignedRiders.map(rider => 
                        `<option value="${rider.rider_id}">${escapeHtml(rider.name)} (${escapeHtml(rider.nationality)})</option>`
                    ).join('');

                    // Update rider select options for team forms (only unassigned riders)
                    const teamFormRiderSelects = document.querySelectorAll('select[name="rider1_id"], select[name="rider2_id"]');
                    teamFormRiderSelects.forEach(select => {
                        select.innerHTML = '<option value="">Select a rider</option>' + unassignedRiderOptions;
                    });

                    // Update rider select options for results form (all riders)
                    const resultRiderSelects = document.querySelectorAll('select[name="rider_id"]');
                    const allRiderOptions = riders.map(rider => 
                        `<option value="${rider.rider_id}">${escapeHtml(rider.name)} (${escapeHtml(rider.nationality)})</option>`
                    ).join('');
                    resultRiderSelects.forEach(select => {
                        select.innerHTML = '<option value="">Select a rider</option>' + allRiderOptions;
                    });
                })
                .catch(error => {
                    console.error('Error loading riders:', error);
                    alert('Failed to load riders. Please refresh the page.');
                });
        }

        function loadTeams() {
            fetch('/api/teams')
                .then(response => response.json())
                .then(teams => {
                    const tbody = document.querySelector('#teamsTable tbody');
                    tbody.innerHTML = '';
                    teams.forEach(team => {
                        tbody.innerHTML += `
                            <tr>
                                <td>${escapeHtml(team.team_name)}</td>
                                <td>${escapeHtml(team.rider1_name || '-')}</td>
                                <td>${escapeHtml(team.rider2_name || '-')}</td>
                                <td>
                                    ${team.team_picture ? 
                                        `<img src="/images/teams/${team.team_picture}" 
                                              alt="${escapeHtml(team.team_name)}"
                                              onerror="this.onerror=null; this.src='/images/teams/default-team.webp';"
                                              style="max-height: 50px;">` : 
                                        '<img src="/images/teams/default-team.webp" alt="Default Team" style="max-height: 50px;">'
                                    }
                                </td>
                                <td>
                                    <button class="btn btn-warning btn-sm" onclick="editTeam(${team.team_id})">Edit</button>
                                    <button class="btn btn-danger btn-sm" onclick="deleteTeam(${team.team_id})">Delete</button>
                                </td>
                            </tr>
                        `;
                    });
                })
                .catch(error => {
                    console.error('Error loading teams:', error);
                    alert('Failed to load teams. Please try again.');
                });
        }

        function loadResults() {
            // First load races for the filter dropdown
            fetch('/api/calendar')
                .then(response => response.json())
                .then(races => {
                    const raceSelect = document.getElementById('raceSelect');
                    raceSelect.innerHTML = '<option value="">All Races</option>';
                    
                    // Filter races that have results
                    const completedRaces = races.filter(race => race.has_results > 0);
                    
                    completedRaces.forEach(race => {
                        raceSelect.innerHTML += `
                            <option value="${race.calendar_id}">${race.race_name}</option>
                        `;
                    });
                })
                .catch(error => {
                    console.error('Error loading races:', error);
                    alert('Failed to load races. Please try again.');
                });

            // Load all results by default
            loadRaceResults('');
        }

        // Function to load results for a specific race or all races
        function loadRaceResults(raceId) {
            const url = raceId ? `/api/results?race=${raceId}` : '/api/results';
            
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    const tbody = document.querySelector('#resultsTable tbody');
                    tbody.innerHTML = '';

                    // If it's all races
                    if (!raceId) {
                        // Group results by race
                        const resultsByRace = {};
                        data.forEach(result => {
                            if (!resultsByRace[result.calendar_id]) {
                                resultsByRace[result.calendar_id] = {
                                    race_name: result.race_name,
                                    results: []
                                };
                            }
                            resultsByRace[result.calendar_id].results.push(result);
                        });

                        // Sort races by date and add to table
                        Object.values(resultsByRace).forEach(race => {
                            // Add race header
                            tbody.innerHTML += `
                                <tr class="race-header">
                                    <td colspan="6">${race.race_name}</td>
                                </tr>
                            `;

                            // Add race results
                            race.results.sort((a, b) => {
                                if (a.points !== b.points) {
                                    return b.points - a.points;
                                }
                                if (a.race_time === 'DNF' && b.race_time !== 'DNF') {
                                    return 1;
                                }
                                if (a.race_time !== 'DNF' && b.race_time === 'DNF') {
                                    return -1;
                                }
                                return a.race_time.localeCompare(b.race_time);
                            }).forEach(result => {
                                tbody.innerHTML += `
                                    <tr>
                                        <td>${result.position || 'Not set'}</td>
                                        <td>${result.rider_name}</td>
                                        <td>${result.team_name}</td>
                                        <td>${result.race_time || 'DNF'}</td>
                                        <td>${result.points}</td>
                                        <td>
                                            <button class="btn btn-warning" onclick="editResult(${result.result_id})">Edit</button>
                                            <button class="btn btn-danger" onclick="deleteResult(${result.result_id})">Delete</button>
                                        </td>
                                    </tr>
                                `;
                            });
                        });
                    } else {
                        // Single race view
                        if (data.race_status === 'finished' && data.results && data.results.length > 0) {
                            data.results.sort((a, b) => {
                                if (a.points !== b.points) {
                                    return b.points - a.points;
                                }
                                if (a.race_time === 'DNF' && b.race_time !== 'DNF') {
                                    return 1;
                                }
                                if (a.race_time !== 'DNF' && b.race_time === 'DNF') {
                                    return -1;
                                }
                                return a.race_time.localeCompare(b.race_time);
                            }).forEach(result => {
                                tbody.innerHTML += `
                                    <tr>
                                        <td>${result.position || 'Not set'}</td>
                                        <td>${result.rider_name}</td>
                                        <td>${result.team_name}</td>
                                        <td>${result.race_time || 'DNF'}</td>
                                        <td>${result.points}</td>
                                        <td>
                                            <button class="btn btn-warning" onclick="editResult(${result.result_id})">Edit</button>
                                            <button class="btn btn-danger" onclick="deleteResult(${result.result_id})">Delete</button>
                                        </td>
                                    </tr>
                                `;
                            });
                        } else {
                            tbody.innerHTML = `
                                <tr>
                                    <td colspan="6" class="text-center">No results available for this race</td>
                                </tr>
                            `;
                        }
                    }
                })
                .catch(error => {
                    console.error('Error loading results:', error);
                    alert('Failed to load results. Please try again.');
                });
        }

        function loadCalendar() {
            fetch('/api/calendar')
                .then(response => response.json())
                .then(races => {
                    const tbody = document.querySelector('#calendarTable tbody');
                    tbody.innerHTML = '';
                    races.forEach(race => {
                        // Format dates for display
                        const startDate = new Date(race.start_date).toLocaleDateString();
                        const endDate = new Date(race.end_date).toLocaleDateString();
                        
                        tbody.innerHTML += `
                            <tr>
                                <td>${race.race_name}</td>
                                <td>${race.country}</td>
                                <td>${startDate}</td>
                                <td>${endDate}</td>
                                <td>
                                    <button class="btn btn-sm btn-warning" onclick="editRace(${race.calendar_id})">Edit</button>
                                    <button class="btn btn-sm btn-danger" onclick="deleteRace(${race.calendar_id})">Delete</button>
                                </td>
                            </tr>
                        `;
                    });

                    // Update race select options in result forms
                    const raceSelects = document.querySelectorAll('select[name="calendar_id"]');
                    const raceOptions = races.map(race => 
                        `<option value="${race.calendar_id}">${race.race_name}</option>`
                    ).join('');
                    raceSelects.forEach(select => select.innerHTML = raceOptions);
                });
        }

        // Edit functions
        function editRider(riderId) {
            // Fetch rider details
            fetch(`/api/riders/${riderId}`)
                .then(response => response.json())
                .then(rider => {
                    const form = document.querySelector('#editRiderForm');
                    form.querySelector('[name="rider_id"]').value = rider.rider_id;
                    form.querySelector('[name="current_team_id"]').value = rider.team_id || '';
                    form.querySelector('[name="name"]').value = rider.name;
                    form.querySelector('[name="country"]').value = rider.country;
                    
                    // Load available teams
                    loadAvailableTeams(rider.team_id);
                    
                    // Show modal
                    const modal = new bootstrap.Modal(document.getElementById('editRiderModal'));
                    modal.show();
                })
                .catch(error => {
                    console.error('Error fetching rider:', error);
                    alert('Failed to load rider details. Please try again.');
                });
        }

        function editTeam(id) {
            fetch(`/api/teams/${id}`)
                .then(response => {
                    if (!response.ok) throw new Error('Network response was not ok');
                    return response.json();
                })
                .then(team => {
                    const form = document.getElementById('editTeamForm');
                    
                    // Remove old event listeners by replacing select elements
                    const rider1Select = form.querySelector('[name="rider1_id"]');
                    const rider2Select = form.querySelector('[name="rider2_id"]');
                    const newRider1Select = rider1Select.cloneNode(true);
                    const newRider2Select = rider2Select.cloneNode(true);
                    rider1Select.parentNode.replaceChild(newRider1Select, rider1Select);
                    rider2Select.parentNode.replaceChild(newRider2Select, rider2Select);
                    
                    // Set form values
                    form.querySelector('[name="team_id"]').value = team.team_id;
                    form.querySelector('[name="team_name"]').value = team.team_name;
                    form.querySelector('[name="current_rider1_id"]').value = team.rider1_id || '';
                    form.querySelector('[name="current_rider2_id"]').value = team.rider2_id || '';
                    
                    // Load available riders with current selections
                    loadAvailableRidersForTeam(team.team_id, team.rider1_id, team.rider2_id);
                    
                    // Show the modal
                    const modal = new bootstrap.Modal(document.getElementById('editTeamModal'));
                    modal.show();
                })
                .catch(error => {
                    console.error('Error loading team details:', error);
                    alert('Failed to load team details. Please try again.');
                });
        }

        // Helper function to load available riders for team form
        function loadAvailableRidersForTeam(teamId, currentRider1Id, currentRider2Id) {
            fetch('/api/riders')
                .then(response => response.json())
                .then(riders => {
                    // Filter riders: include unassigned riders and current team riders
                    const availableRiders = riders.filter(rider => 
                        !rider.team_id || 
                        rider.team_id === teamId ||
                        rider.rider_id === currentRider1Id ||
                        rider.rider_id === currentRider2Id
                    );

                    // Update rider select options
                    const rider1Select = document.querySelector('#editTeamForm [name="rider1_id"]');
                    const rider2Select = document.querySelector('#editTeamForm [name="rider2_id"]');
                    
                    // Function to generate options list excluding a specific rider
                    const generateOptions = (selectedRiderId = null) => {
                        return availableRiders
                            .filter(rider => rider.rider_id !== selectedRiderId)
                            .map(rider => `
                                <option value="${rider.rider_id}">
                                    ${escapeHtml(rider.name)} (${escapeHtml(rider.nationality)})
                                    ${rider.team_id === teamId ? ' (Current)' : ''}
                                </option>
                            `).join('');
                    };

                    // Initial population of select elements
                    rider1Select.innerHTML = '<option value="">Select Rider 1</option>' + generateOptions(null);
                    rider2Select.innerHTML = '<option value="">Select Rider 2</option>' + generateOptions(null);

                    // Set initial values
                    if (currentRider1Id) rider1Select.value = currentRider1Id;
                    if (currentRider2Id) rider2Select.value = currentRider2Id;

                    // Add change event listeners to update available options
                    rider1Select.addEventListener('change', function() {
                        const selectedRider = this.value;
                        rider2Select.innerHTML = '<option value="">Select Rider 2</option>' + generateOptions(selectedRider);
                        if (currentRider2Id && currentRider2Id !== selectedRider) {
                            rider2Select.value = currentRider2Id;
                        }
                    });

                    rider2Select.addEventListener('change', function() {
                        const selectedRider = this.value;
                        rider1Select.innerHTML = '<option value="">Select Rider 1</option>' + generateOptions(selectedRider);
                        if (currentRider1Id && currentRider1Id !== selectedRider) {
                            rider1Select.value = currentRider1Id;
                        }
                    });

                    // Trigger change events to update options
                    rider1Select.dispatchEvent(new Event('change'));
                })
                .catch(error => {
                    console.error('Error loading available riders:', error);
                    alert('Failed to load available riders. Please try again.');
                });
        }

        function editResult(id) {
            fetch(`/api/results/${id}`)
                .then(response => response.json())
                .then(result => {
                    const form = document.getElementById('editResultForm');
                    form.result_id.value = result.result_id;
                    form.calendar_id.value = result.calendar_id;
                    form.rider_id.value = result.rider_id;
                    form.team_id.value = result.team_id;
                    form.race_time.value = result.race_time;
                    new bootstrap.Modal(document.getElementById('editResultModal')).show();
                });
        }

        function editRace(id) {
            fetch(`/api/calendar/${id}`)
                .then(response => {
                    if (!response.ok) throw new Error('Network response was not ok');
                    return response.json();
                })
                .then(race => {
                    const form = document.getElementById('editCalendarForm');
                    form.querySelector('[name="calendar_id"]').value = race.calendar_id;
                    form.querySelector('[name="race_name"]').value = race.race_name;
                    form.querySelector('[name="country"]').value = race.country;
                    
                    // Format dates for input fields (YYYY-MM-DD)
                    const startDate = new Date(race.start_date);
                    const endDate = new Date(race.end_date);
                    form.querySelector('[name="start_date"]').value = startDate.toISOString().split('T')[0];
                    form.querySelector('[name="end_date"]').value = endDate.toISOString().split('T')[0];
                    
                    // Show the modal
                    const modal = new bootstrap.Modal(document.getElementById('editCalendarModal'));
                    modal.show();
                })
                .catch(error => {
                    console.error('Error loading race details:', error);
                    alert('Failed to load race details. Please try again.');
                });
        }

        // Delete functions
        function deleteRider(id) {
            if (confirm('Are you sure you want to delete this rider?')) {
                fetch(`/api/riders/${id}`, { method: 'DELETE' })
                    .then(() => {
                        loadRiders();
                        loadTeams(); // Refresh teams as rider might be referenced
                    });
            }
        }

        function deleteTeam(id) {
            if (confirm('Are you sure you want to delete this team?')) {
                fetch(`/api/teams/${id}`, { method: 'DELETE' })
                    .then(() => {
                        loadTeams();
                        loadRiders(); // Refresh riders as team might be referenced
                    });
            }
        }

        function deleteResult(id) {
            if (confirm('Are you sure you want to delete this result?')) {
                fetch(`/api/results/${id}`, { method: 'DELETE' })
                    .then(() => loadResults());
            }
        }

        function deleteRace(id) {
            if (confirm('Are you sure you want to delete this race? This will also delete all race results associated with it.')) {
                fetch(`/api/calendar/${id}`, { method: 'DELETE' })
                    .then(response => {
                        if (!response.ok) throw new Error('Network response was not ok');
                        return response.json();
                    })
                    .then(() => {
                        loadCalendar();
                        loadResults(); // Refresh results as they might be affected
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('Failed to delete race. Please try again.');
                    });
            }
        }

        // Form submission handlers
        document.getElementById('addRiderForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            
            try {
                // First upload the photo
                const photoFile = formData.get('photo');
                if (photoFile.size > 0) {
                    const photoFormData = new FormData();
                    photoFormData.append('photo', photoFile);
                    
                    const uploadResponse = await fetch('/api/upload/rider', {
                        method: 'POST',
                        body: photoFormData
                    });
                    
                    if (!uploadResponse.ok) {
                        throw new Error('Failed to upload photo');
                    }
                    
                    const uploadResult = await uploadResponse.json();
                    formData.set('image_url', uploadResult.filename);
                }
                
                // Then submit the rider data
                const riderData = {
                    name: formData.get('name'),
                    country: formData.get('country'),
                    team_id: formData.get('team_id') || null,
                    image_url: formData.get('image_url')
                };
                
                const response = await fetch('/api/riders', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(riderData)
                });
                
                if (!response.ok) {
                    throw new Error('Failed to add rider');
                }
                
                await loadRiders();
                e.target.reset();
                bootstrap.Modal.getInstance(document.getElementById('addRiderModal')).hide();
            } catch (error) {
                console.error('Error:', error);
                alert('Failed to add rider. Please try again.');
            }
        });

        document.getElementById('editRiderForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const riderId = formData.get('rider_id');
            
            try {
                let updateData = {
                    name: formData.get('name'),
                    country: formData.get('country'),
                    team_id: formData.get('team_id') || null
                };

                // Handle photo upload if a new photo is selected
                const photoFile = formData.get('photo');
                if (photoFile.size > 0) {
                    // Create a new FormData for the photo upload
                    const photoFormData = new FormData();
                    photoFormData.append('photo', photoFile);

                    // Upload the photo first
                    const uploadResponse = await fetch('/api/upload/rider', {
                        method: 'POST',
                        body: photoFormData
                    });

                    if (!uploadResponse.ok) {
                        throw new Error('Failed to upload photo');
                    }

                    const uploadResult = await uploadResponse.json();
                    if (uploadResult.success) {
                        // Add the new image filename to the update data
                        updateData.image_url = uploadResult.filename;
                    } else {
                        throw new Error(uploadResult.error || 'Failed to upload photo');
                    }
                }

                // Update rider details
                const updateResponse = await fetch(`/api/riders/${riderId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(updateData)
                });

                if (!updateResponse.ok) {
                    throw new Error('Failed to update rider');
                }

                const updateResult = await updateResponse.json();
                if (updateResult.success) {
                    // Close modal and reload riders
                    bootstrap.Modal.getInstance(document.getElementById('editRiderModal')).hide();
                    loadRiders();
                    
                    // Show success message
                    alert('Rider updated successfully');
                } else {
                    throw new Error(updateResult.error || 'Failed to update rider');
                }
            } catch (error) {
                console.error('Error updating rider:', error);
                alert(error.message || 'Failed to update rider. Please try again.');
            }
        });

        document.getElementById('addTeamForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const formData = new FormData(this);

            try {
                // First upload team photo
                const teamPhotoFormData = new FormData();
                const teamPhoto = formData.get('team_photo');
                teamPhotoFormData.append('team_photo', teamPhoto);
                teamPhotoFormData.append('team_name', formData.get('team_name'));
                
                const teamPhotoResponse = await fetch('/api/upload/team', {
                    method: 'POST',
                    body: teamPhotoFormData
                });
                
                if (!teamPhotoResponse.ok) throw new Error('Failed to upload team photo');
                const teamPhotoResult = await teamPhotoResponse.json();

                // Handle riders (both new and existing)
                const rider1Data = await handleRider(formData, '1');
                const rider2Data = await handleRider(formData, '2');

                // Create team with riders
                const teamData = {
                    team_name: formData.get('team_name'),
                    team_picture: teamPhotoResult.filename,
                    rider1_id: rider1Data.rider_id,
                    rider2_id: rider2Data.rider_id
                };

                const response = await fetch('/api/teams', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(teamData)
                });

                if (!response.ok) throw new Error('Failed to create team');

                // Refresh the lists and close modal
                await loadTeams();
                await loadRiders();
                this.reset();
                bootstrap.Modal.getInstance(document.getElementById('addTeamModal')).hide();

            } catch (error) {
                console.error('Error:', error);
                alert('Failed to create team. Please try again.');
            }
        });

        async function handleRider(formData, riderNum) {
            const riderType = formData.get(`rider${riderNum}_type`);
            
            if (riderType === 'existing') {
                return { rider_id: formData.get(`rider${riderNum}_id`) };
            } else {
                // Upload rider photo
                const photoFormData = new FormData();
                const photo = formData.get(`rider${riderNum}_photo`);
                photoFormData.append('photo', photo);
                
                const photoResponse = await fetch('/api/upload/rider', {
                    method: 'POST',
                    body: photoFormData
                });
                
                if (!photoResponse.ok) throw new Error(`Failed to upload rider ${riderNum} photo`);
                const photoResult = await photoResponse.json();

                // Create new rider
                const riderData = {
                    name: formData.get(`rider${riderNum}_name`),
                    country: formData.get(`rider${riderNum}_nationality`),
                    image_url: photoResult.filename
                };

                const response = await fetch('/api/riders', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(riderData)
                });

                if (!response.ok) throw new Error(`Failed to create rider ${riderNum}`);
                const result = await response.json();
                return { rider_id: result.rider_id };
            }
        }

        // Initialize form when modal is shown
        document.getElementById('addTeamModal').addEventListener('show.bs.modal', function() {
            initializeTeamForm();
        });

        function initializeTeamForm() {
            // Handle Rider 1 type selection
            document.querySelectorAll('input[name="rider1_type"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    document.querySelector('.rider1-existing').style.display = 
                        this.value === 'existing' ? 'block' : 'none';
                    document.querySelector('.rider1-new').style.display = 
                        this.value === 'new' ? 'block' : 'none';
                    
                    // Update form validation
                    const rider1Select = document.querySelector('select[name="rider1_id"]');
                    const rider1Inputs = document.querySelectorAll('.rider1-new input');
                    
                    if (this.value === 'existing') {
                        rider1Select.required = true;
                        rider1Inputs.forEach(input => input.required = false);
                    } else {
                        rider1Select.required = false;
                        rider1Inputs.forEach(input => input.required = true);
                    }
                });
            });

            // Handle Rider 2 type selection
            document.querySelectorAll('input[name="rider2_type"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    document.querySelector('.rider2-existing').style.display = 
                        this.value === 'existing' ? 'block' : 'none';
                    document.querySelector('.rider2-new').style.display = 
                        this.value === 'new' ? 'block' : 'none';
                    
                    // Update form validation
                    const rider2Select = document.querySelector('select[name="rider2_id"]');
                    const rider2Inputs = document.querySelectorAll('.rider2-new input');
                    
                    if (this.value === 'existing') {
                        rider2Select.required = true;
                        rider2Inputs.forEach(input => input.required = false);
                    } else {
                        rider2Select.required = false;
                        rider2Inputs.forEach(input => input.required = true);
                    }
                });
            });

            // Update available riders when first rider is selected
            document.querySelector('select[name="rider1_id"]').addEventListener('change', function() {
                const selectedRider = this.value;
                const rider2Select = document.querySelector('select[name="rider2_id"]');
                
                // Re-enable all options
                rider2Select.querySelectorAll('option').forEach(option => {
                    option.disabled = false;
                });
                
                // Disable the selected rider in rider 2 dropdown
                if (selectedRider) {
                    const option = rider2Select.querySelector(`option[value="${selectedRider}"]`);
                    if (option) option.disabled = true;
                }
            });
        }

        document.getElementById('editTeamForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const teamId = formData.get('team_id');
            
            try {
                let updateData = {
                    team_name: formData.get('team_name'),
                    rider1_id: formData.get('rider1_id') || null,
                    rider2_id: formData.get('rider2_id') || null
                };

                // Handle team photo upload if a new photo is selected
                const photoFile = formData.get('team_photo');
                if (photoFile.size > 0) {
                    // Create a new FormData for the photo upload
                    const photoFormData = new FormData();
                    photoFormData.append('team_photo', photoFile);

                    // Upload the photo first
                    const uploadResponse = await fetch('/api/upload/team', {
                        method: 'POST',
                        body: photoFormData
                    });

                    if (!uploadResponse.ok) {
                        throw new Error('Failed to upload team photo');
                    }

                    const uploadResult = await uploadResponse.json();
                    if (uploadResult.success) {
                        // Add the new image filename to the update data
                        updateData.team_picture = uploadResult.filename;
                    } else {
                        throw new Error(uploadResult.error || 'Failed to upload team photo');
                    }
                }

                // Update team details
                const updateResponse = await fetch(`/api/teams/${teamId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(updateData)
                });

                if (!updateResponse.ok) {
                    throw new Error('Failed to update team');
                }

                const updateResult = await updateResponse.json();
                if (updateResult.success) {
                    // Close modal and reload teams
                    bootstrap.Modal.getInstance(document.getElementById('editTeamModal')).hide();
                    loadTeams();
                    
                    // Show success message
                    alert('Team updated successfully');
                } else {
                    throw new Error(updateResult.error || 'Failed to update team');
                }
            } catch (error) {
                console.error('Error updating team:', error);
                alert(error.message || 'Failed to update team. Please try again.');
            }
        });

        document.getElementById('addResultForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData);
            
            // Validate required fields
            if (!data.calendar_id || !data.rider_id || !data.team_id || !data.race_time || !data.points) {
                alert('Please fill in all required fields');
                return;
            }

            try {
                // First, add the new result
                const addResponse = await fetch('/api/results', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        calendar_id: parseInt(data.calendar_id),
                        rider_id: parseInt(data.rider_id),
                        team_id: parseInt(data.team_id),
                        race_time: data.race_time,
                        points: parseInt(data.points)
                    })
                });

                if (!addResponse.ok) {
                    const errorData = await addResponse.json();
                    throw new Error(errorData.error || 'Failed to add result');
                }

                // Reload results table
                loadResults();
                
                // Reset form and close modal
                e.target.reset();
                bootstrap.Modal.getInstance(document.getElementById('addResultModal')).hide();
                
                alert('Result added successfully!');
            } catch (error) {
                console.error('Error:', error);
                alert(error.message || 'Failed to add result. Please try again.');
            }
        });

        document.getElementById('editResultForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData);
            
            // Validate required fields
            if (!data.calendar_id || !data.rider_id || !data.team_id || !data.race_time) {
                alert('Please fill in all required fields');
                return;
            }

            fetch(`/api/results/${data.result_id}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            })
            .then(response => {
                if (!response.ok) throw new Error('Network response was not ok');
                return response.json();
            })
            .then(() => {
                loadResults();
                bootstrap.Modal.getInstance(document.getElementById('editResultModal')).hide();
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Failed to update result. Please try again.');
            });
        });

        document.getElementById('addCalendarForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData);

            // Additional client-side validation
            if (!data.race_name || !data.country || !data.start_date || !data.end_date) {
                alert('Please fill in all fields');
                return;
            }

            // Validate dates
            const startDate = new Date(data.start_date);
            const endDate = new Date(data.end_date);
            
            if (endDate < startDate) {
                alert('End date cannot be before start date');
                return;
            }

            fetch('/api/calendar', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            })
            .then(response => {
                if (!response.ok) throw new Error('Network response was not ok');
                return response.json();
            })
            .then(() => {
                loadCalendar();
                e.target.reset();
                bootstrap.Modal.getInstance(document.getElementById('addCalendarModal')).hide();
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Failed to add race. Please try again.');
            });
        });

        document.getElementById('editCalendarForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const raceId = formData.get('calendar_id');
            
            try {
                // Validate dates
                const startDate = new Date(formData.get('start_date'));
                const endDate = new Date(formData.get('end_date'));
                
                if (endDate < startDate) {
                    throw new Error('End date cannot be before start date');
                }

                const updateData = {
                    race_name: formData.get('race_name'),
                    country: formData.get('country'),
                    start_date: formData.get('start_date'),
                    end_date: formData.get('end_date')
                };

                // Update race details
                const response = await fetch(`/api/calendar/${raceId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(updateData)
                });

                const result = await response.json();
                
                if (!response.ok) {
                    throw new Error(result.error || 'Failed to update race');
                }

                // Close modal and reload calendar
                bootstrap.Modal.getInstance(document.getElementById('editCalendarModal')).hide();
                loadCalendar();
                
                // Show success message
                alert('Race updated successfully');
                
            } catch (error) {
                console.error('Error updating race:', error);
                alert(error.message || 'Failed to update race. Please try again.');
            }
        });

        // Add race filter handler
        document.getElementById('raceSelect').addEventListener('change', function(e) {
            loadRaceResults(e.target.value);
        });

        // Initial load
        loadRiders();
        loadTeams();
        loadResults();
        loadCalendar();

        // Helper function to escape HTML and prevent XSS
        function escapeHtml(unsafe) {
            if (!unsafe) return '';
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        // Function to load available teams for rider assignment
        function loadAvailableTeams(currentTeamId) {
            fetch('/api/teams')
                .then(response => response.json())
                .then(teams => {
                    const teamSelect = document.querySelector('#editRiderForm select[name="team_id"]');
                    teamSelect.innerHTML = '<option value="">No Team</option>';
                    
                    teams.forEach(team => {
                        // Count current riders in team
                        let riderCount = 0;
                        if (team.rider1_name) riderCount++;
                        if (team.rider2_name) riderCount++;
                        
                        // Add team as option if it's the current team or has space
                        if (team.team_id === currentTeamId || riderCount < 2) {
                            teamSelect.innerHTML += `
                                <option value="${team.team_id}" ${team.team_id === currentTeamId ? 'selected' : ''}>
                                    ${team.team_name} (${riderCount}/2 riders)
                                </option>
                            `;
                        }
                    });
                })
                .catch(error => console.error('Error loading teams:', error));
        }

        function showAddResultModal() {
            // Load races for the dropdown
            fetch('/api/calendar')
                .then(response => response.json())
                .then(races => {
                    const raceSelect = document.querySelector('#addResultForm select[name="calendar_id"]');
                    raceSelect.innerHTML = '<option value="">Select Race</option>';
                    races.forEach(race => {
                        raceSelect.innerHTML += `<option value="${race.calendar_id}">${race.race_name}</option>`;
                    });
                });

            // Load riders for the dropdown
            fetch('/api/riders')
                .then(response => response.json())
                .then(riders => {
                    const riderSelect = document.querySelector('#addResultForm select[name="rider_id"]');
                    riderSelect.innerHTML = '<option value="">Select Rider</option>';
                    riders.forEach(rider => {
                        riderSelect.innerHTML += `<option value="${rider.rider_id}">${rider.name}</option>`;
                    });
                });

            // Load teams for the dropdown
            fetch('/api/teams')
                .then(response => response.json())
                .then(teams => {
                    const teamSelect = document.querySelector('#addResultForm select[name="team_id"]');
                    teamSelect.innerHTML = '<option value="">Select Team</option>';
                    teams.forEach(team => {
                        teamSelect.innerHTML += `<option value="${team.team_id}">${team.team_name}</option>`;
                    });
                });

            // Show the modal
            const modal = new bootstrap.Modal(document.getElementById('addResultModal'));
            modal.show();
        }
    </script>
</body>
</html> 